import os
from . import pdir_config as cfg

GITIGNORE_TEMPLATE = cfg.GITIGNORE_TEMPLATE


def create_python_files(folder_path):
    print("Введите названия файлов через запятую (с расширением .py или без, Enter — закончить):")
    files_input = input("Файлы: ").strip()
    if files_input:
        files = [f.strip() for f in files_input.split(",") if f.strip()]
        for file in files:
            if not file.endswith(".py"):
                file += ".py"
            full_path = os.path.join(folder_path, file)
            with open(full_path, 'w', encoding='utf-8') as fp:
                fp.write('')
            print(f"Файл создан: {file}")
    else:
        print("Файлы не введены.")


# Функция для запроса создания README.md
def create_readme(folder_path):
    add_readme = input(
        f"Создать README.md в папке '{os.path.basename(folder_path)}'? (да/нет): "
    ).strip().lower()

    if add_readme in ("да", "yes", "y"):
        readme_path = os.path.join(folder_path, "README.md")
        with open(readme_path, 'w', encoding='utf-8') as fp:
            fp.write(f"# {os.path.basename(folder_path)}\n")
        print("README.md создан.")


# Функция для запроса создания .gitignore
def create_gitignore(folder_path):
    add_gitignore = input(
        f"Создать .gitignore в папке '{os.path.basename(folder_path)}'? (да/нет): "
    ).strip().lower()

    if add_gitignore in ("да", "yes", "y"):
        gitignore_path = os.path.join(folder_path, ".gitignore")
        with open(gitignore_path, 'w', encoding='utf-8') as fp:
            fp.write(GITIGNORE_TEMPLATE)
        print(".gitignore создан.")


# Основная функция для запроса и создания файлов
def ask_files_in_folder(folder_path):
    # Ввод для создания Python-файлов
    add_files = input(
        f"Создать Python файлы в папке '{os.path.basename(folder_path)}'? "
        "(да/нет, n — отмена, !n — пропустить весь этап): "
    ).strip().lower()

    if add_files == "!n":
        print("Этап создания файлов пропущен полностью.")
        return  # Пропускаем весь этап

    if add_files in ("n", "no"):
        print("Создание Python-файлов отменено.")
        return

    if add_files in ("да", "yes", "y"):
        # Создание Python файлов
        create_python_files(folder_path)

        # Создание README.md
        create_readme(folder_path)

        # Создание .gitignore
        create_gitignore(folder_path)

def create_folders_recursive(current_path, root_path):
    while True:
        folder_name = input(
            f"Введите название папки в '{os.path.basename(current_path)}' "
            "(Enter — вернуться назад, '!' — к корню): "
        ).strip()
        if folder_name == "!":
            return root_path
        if not folder_name:
            return current_path
        folder_path = os.path.join(current_path, folder_name)
        os.makedirs(folder_path, exist_ok=True)
        print(f"Создана папка: {folder_path}")

        ask_files_in_folder(folder_path)

        # Рекурсивный вызов для вложенных папок
        res = create_folders_recursive(folder_path, root_path)
        if res == root_path:
            return root_path

def main():
    workdir = input("Введите название рабочей директории (Enter — текущая директория): ").strip()
    if not workdir:
        workdir = os.getcwd()
    else:
        os.makedirs(workdir, exist_ok=True)
    print(f"Рабочая директория: {workdir}")

    create_folders_recursive(workdir, workdir)

    print("\nСтруктура созданной директории:\n")
    for root, dirs, files in os.walk(workdir):
        level = root.replace(workdir, "").count(os.sep)
        indent = " " * 4 * level
        print(f"{indent}{os.path.basename(root)}/")
        sub_indent = " " * 4 * (level + 1)
        for f in files:
            print(f"{sub_indent}{f}")

if __name__ == '__main__':
    main()
