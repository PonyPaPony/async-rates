import os
import sys
import subprocess


def run_command(cmd_list):
    """Запускает команду безопасным способом (без shell=True)."""
    print(f"> {' '.join(cmd_list)}")
    try:
        subprocess.run(cmd_list, check=True)
    except subprocess.CalledProcessError as e:
        print(f"Ошибка при выполнении команды: {e}")
        sys.exit(1)

def is_git_repo():
    """Проверяет, инициализирован ли git репозиторий."""
    try:
        subprocess.check_output(
            ["git", "rev-parse", "--is-inside-work-tree"],
            stderr=subprocess.DEVNULL
        )
        return True
    except subprocess.CalledProcessError:
        return False

def has_remote():
    """Проверяет, настроен ли remote origin."""
    try:
        subprocess.check_output(
            ["git", "remote", "get-url", "origin"],
            stderr=subprocess.DEVNULL
        )
        return True
    except subprocess.CalledProcessError:
        return False

def check_git():
    if not is_git_repo():
        print("Репозиторий не найден. Инициализирую...")
        run_command(['git', 'init'])

def check_remote():
    if not has_remote():
        repo = input("Введите URL удаленного репозитория (например, github.com/...): ").strip()
        if repo:
            run_command(['git', 'remote', 'add', 'origin', repo])
            run_command(['git', 'branch', "-M", 'main'])
        else:
            print("URL не введен. Пропускаем настройку remote.")

def get_commit_message():
    if len(sys.argv) > 1:
        return sys.argv[1]
    else:
        msg = input("Введите сообщение коммита: ").strip()
        if not msg:
            msg = "Update"
        return msg

def push_to_remote():
    if has_remote():
        try:
            run_command(['git', 'push', '-u', 'origin', 'main'])
        except SystemExit:
            print("Не удалось выполнить push. Проверьте права доступа или URL.")
    else:
        print("Remote не настроен, push не выполнен.")

def main():
    check_git()
    check_remote()

    msg = get_commit_message()

    run_command(['git', 'add', '.'])

    try:
        run_command(['git', 'commit', '-m', msg])
    except SystemExit:
        print("Нечего коммитить (working tree clean).")
        return

    push_to_remote()


if __name__ == '__main__':
    main()