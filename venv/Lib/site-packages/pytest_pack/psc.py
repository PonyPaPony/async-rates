import os
import sys
import subprocess
import argparse
import shutil
from . import config_pt as cfg


class PytestScript:
    def __init__(self):
        self.actions = {
            "1": self.run_simple_test,
            "2": self.run_coverage_test,
            "3": self.run_html_coverage,
            "4": self.custom_command,
            "5": self.clean_project
        }
        self.menu_loop()

    # ---------------- MENU LOOP ---------------- #

    def menu_loop(self):
        print("--- –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–µ–Ω—é PyTestScript ---")

        while True:
            self.print_menu()
            choice = input("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: ").strip()

            if choice == "":
                print("–í—ã—Ö–æ–¥ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã...")
                break

            action = self.actions.get(choice)

            if action is None:
                print("–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
                continue

            action()

    @staticmethod
    def print_menu():
        for key, value in cfg.CHOICE_MENU.items():
            print(f"{key}: {value}\n")
        print("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞\n")

    # ---------------- UTILITIES ---------------- #

    @staticmethod
    def run_test(cmd_list):
        print("> " + " ".join(cmd_list))
        try:
            subprocess.run(cmd_list, check=True)
        except subprocess.CalledProcessError as e:
            print(f"–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {e}")
            sys.exit(1)

    @staticmethod
    def ask_path(prompt):
        return input(prompt).strip()

    # ---------------- ACTIONS ---------------- #

    def run_simple_test(self):
        self.run_test(cfg.MAIN_COMMAND.split())

    def run_coverage_test(self):
        path = self.ask_path("–£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–º—É —Ñ–∞–π–ª—É (–ø—Ä–∏–º–µ—Ä: tests/): ")
        command = (cfg.COV_COMMAND + path).split()
        self.run_test(command)

    def run_html_coverage(self):
        path = self.ask_path("–£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –¥–ª—è HTML-–æ—Ç—á–µ—Ç–∞ (–ø—Ä–∏–º–µ—Ä: tests/): ")
        command = (cfg.COV_REP_COMMAND + path).split()
        self.run_test(command)

    def custom_command(self):
        custom_args = input("–ê—Ä–≥—É–º–µ–Ω—Ç—ã pytest (–ø—Ä–∏–º–µ—Ä: --maxfail=5): ").strip()
        cmd = [cfg.MAIN_COMMAND]

        if custom_args:
            cmd.extend(custom_args.split())

        self.run_test(cmd)

    # ---------------- CLEANUP ---------------- #

    def clean_project(self):
        self.show_cleanup_targets()

        if not self.confirm():
            print("–û—á–∏—Å—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
            return

        for item in cfg.TO_DELETE:
            self.delete_item(item)

        print("\n–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")

    @staticmethod
    def show_cleanup_targets():
        print("–ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã:")
        for item in cfg.TO_DELETE:
            print(f" - {item}")

    @staticmethod
    def confirm():
        return input("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): ").strip().lower() == "y"

    def delete_item(self, item):
        normalized = item.rstrip("/\\")  # üî• —Ç–≤–æ—è –ø—Ä–æ—Å—å–±–∞: –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—É—Ç–∏

        if os.path.isdir(normalized):
            self.remove_dir(normalized)
        elif os.path.isfile(normalized):
            self.remove_file(normalized)
        else:
            print(f"'{normalized}' ‚Äî –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º.")

    @staticmethod
    def remove_dir(path):
        try:
            shutil.rmtree(path)
            print(f"–ü–∞–ø–∫–∞ '{path}' —É–¥–∞–ª–µ–Ω–∞.")
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–∞–ø–∫–∏ '{path}': {e}")

    @staticmethod
    def remove_file(path):
        try:
            os.remove(path)
            print(f"–§–∞–π–ª '{path}' —É–¥–∞–ª—ë–Ω.")
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ '{path}': {e}")


# ---------------- ENTRY POINT ---------------- #

def main():
    parser = argparse.ArgumentParser(description="–ó–∞–ø—É—Å–∫ PytestScript")
    parser.add_argument("choice", nargs="?", type=str, choices=cfg.CHOICE_MENU.keys())
    args = parser.parse_args()

    app = PytestScript()
    if args.choice:
        app.actions[args.choice]()


if __name__ == "__main__":
    main()
